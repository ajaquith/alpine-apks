# Contributor: Andrew Jaquith <ajaquith@apache.org>
# Maintainer: Andrew Jaquith <ajaquith@apache.org>
pkgname=efs-utils
pkgver=1.12
pkgrel=0
pkgdesc="Amazon Web Services Elastic File System Agent for Alpine 
Linux."
url="https://github.com/ajaquith/alpine-apks"
arch="noarch"
license="MIT"
depends="nfs-utils openssl python3 stunnel"
makedepends=""
install=""
subpackages="$pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/aws/efs-utils/archive/v$pkgver.tar.gz
        amazon-efs-mount-watchdog.initd
        amazon-efs-mount-watchdog.patch
        mount.efs.patch"
builddir="$srcdir/$pkgname-$pkgver"

prepare() {
  echo 'Patching application files'
  cd "$srcdir"
  patch -p1 -i "$srcdir"/amazon-efs-mount-watchdog.patch
  patch -p1 -i "$srcdir"/mount.efs.patch
}

build() {
	return 0
}

check() {
	return 0
}

package() {
  echo 'Creating application directories'
  mkdir -p "$pkgdir"/etc/amazon/efs
  mkdir -p "$pkgdir"/etc/init.d
  mkdir -p "$pkgdir"/sbin
  mkdir -p "$pkgdir"/usr/bin
  mkdir -p "$pkgdir"/usr/share/man
  mkdir -p "$pkgdir"/usr/share/licenses
  mkdir -p "$pkgdir"/usr/share/info

  echo 'Copying application files'
  install -Dm644 "$builddir"/dist/efs-utils.conf "$pkgdir"/etc/amazon/efs
  install -Dm444 "$builddir"/dist/efs-utils.crt "$pkgdir"/etc/amazon/efs
  install -Dm755 "$builddir"/src/watchdog/__init__.py "$pkgdir"/usr/bin/amazon-efs-mount-watchdog
  install -Dm755 "$builddir"/src/mount_efs/__init__.py "$pkgdir"/sbin/mount.efs
  install -Dm755 amazon-efs-mount-watchdog.initd "$pkgdir"/etc/init.d/amazon-efs-mount-watchdog
  sed -i "s/{{ aws_efs_version }}/$pkgver/" "$pkgdir"/etc/init.d/amazon-efs-mount-watchdog
  
  echo 'Copying documentation files'
  install -Dm644 "$builddir"/CONTRIBUTING.md "$pkgdir"/usr/share/info/CONTRIBUTING-"$pkgname-$pkgver".md
  install -Dm644 "$builddir"/NOTICE "$pkgdir"/usr/share/info/NOTICE-"$pkgname-$pkgver".md
  install -Dm644 "$builddir"/requirements.txt "$pkgdir"/usr/share/info/REQUIREMENTS-"$pkgname-$pkgver".md
  install -Dm644 "$builddir"/LICENSE "$pkgdir"/usr/share/licenses/LICENSE-"$pkgname-$pkgver"
  install -Dm644 "$builddir"/man/mount.efs.8 "$pkgdir"/usr/share/man
}

sha512sums="e1b0612a46cfcadad12357e483a2fb2d42680f24107b78156506f2cee17cbb74092a64070abaea5e860fc084f36a57517f06d7191e708be925970bc21a38bc2c  efs-utils-1.12.tar.gz
d7032fb5af15d27d3850f32f628be5af23e33330143c31277a062de7c69868613268f729881febf8f14bca315352182832046521f2e4847bec1ddd8dccdf6903  amazon-efs-mount-watchdog.initd
04868b561f8c6e04a81ef8ad6be69d51effa1ec1b8eab91f82316a4652dccf32e3c0c9cc6d651866d828fe6476f2b69fa871cb2f5a4839b3892f3b442f7bf5f2  amazon-efs-mount-watchdog.patch
028a8c555ba590c6134c87332a643e9c019b565eaee7bc2abd93e3507258bfc244d2da2c71fe05d2b2c0338ba620460e2799c151054c9fad963ec3446fbe2242  mount.efs.patch"
